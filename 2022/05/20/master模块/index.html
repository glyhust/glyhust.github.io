<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.1.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="整体概述master模块是分布式缓存系统的管理中心，需要同时与多个client和cache server交互，并且根据接收到的数据进行不同的逻辑处理。在master主函数中，新建多个线程分别处理不同的业务：接收来自cache server的心跳包和client的指令，并做出相应处理；检测cache心跳包计数是否持续增加；向从master定时发送心跳包。">
<meta property="og:type" content="article">
<meta property="og:title" content="master模块">
<meta property="og:url" content="http://example.com/2022/05/20/master%E6%A8%A1%E5%9D%97/index.html">
<meta property="og:site_name" content="gly的学习博客">
<meta property="og:description" content="整体概述master模块是分布式缓存系统的管理中心，需要同时与多个client和cache server交互，并且根据接收到的数据进行不同的逻辑处理。在master主函数中，新建多个线程分别处理不同的业务：接收来自cache server的心跳包和client的指令，并做出相应处理；检测cache心跳包计数是否持续增加；向从master定时发送心跳包。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/28/XKcfHI.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/28/XKcAtf.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/28/XK2ZLj.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/28/XKR3Nt.png">
<meta property="article:published_time" content="2022-05-20T10:01:21.000Z">
<meta property="article:modified_time" content="2022-05-29T06:17:49.591Z">
<meta property="article:author" content="gong luyang">
<meta property="article:tag" content="学习日志">
<meta property="article:tag" content="master">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://s1.ax1x.com/2022/05/28/XKcfHI.png">

<link rel="canonical" href="http://example.com/2022/05/20/master%E6%A8%A1%E5%9D%97/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>master模块 | gly的学习博客</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">gly的学习博客</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">既是学习记录 又是技术分享</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-webserver">

    <a href="/categories/webserver" rel="section"><i class="fa fa-server fa-fw"></i>WebServer</a>

  </li>
        <li class="menu-item menu-item-分布式缓存">

    <a href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F%E7%BC%93%E5%AD%98" rel="section"><i class="fa fa-cubes fa-fw"></i>分布式缓存</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/05/20/master%E6%A8%A1%E5%9D%97/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/%E5%A4%B4%E5%83%8F.png">
      <meta itemprop="name" content="gong luyang">
      <meta itemprop="description" content="learn">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="gly的学习博客">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          master模块
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-05-20 18:01:21" itemprop="dateCreated datePublished" datetime="2022-05-20T18:01:21+08:00">2022-05-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-05-29 14:17:49" itemprop="dateModified" datetime="2022-05-29T14:17:49+08:00">2022-05-29</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F%E7%BC%93%E5%AD%98/" itemprop="url" rel="index"><span itemprop="name">分布式缓存</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h2 id="整体概述"><a href="#整体概述" class="headerlink" title="整体概述"></a>整体概述</h2><p>master模块是分布式缓存系统的管理中心，需要同时与多个client和cache server交互，并且根据接收到的数据进行不同的逻辑处理。在master主函数中，新建多个线程分别处理不同的业务：接收来自cache server的心跳包和client的指令，并做出相应处理；检测cache心跳包计数是否持续增加；向从master定时发送心跳包。<br><a target="_blank" rel="noopener" href="https://imgtu.com/i/XKcfHI"><img src="https://s1.ax1x.com/2022/05/28/XKcfHI.png" alt="master模块"></a></p>
<span id="more"></span>
<h2 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h2><h3 id="master数据收发"><a href="#master数据收发" class="headerlink" title="master数据收发"></a>master数据收发</h3><p>采用socket编程、epoll函数IO多路复用功能和多线程编程，在master端实时监听前来建立连接的client和cache server。其中client需要与master建立通信，请求最新的cache列表，而cache则定时向master发送心跳包。<br><a target="_blank" rel="noopener" href="https://imgtu.com/i/XKcAtf"><img src="https://s1.ax1x.com/2022/05/28/XKcAtf.png" alt="epoll通信"></a></p>
<h3 id="cache心跳包检测"><a href="#cache心跳包检测" class="headerlink" title="cache心跳包检测"></a>cache心跳包检测</h3><p>master端维护了已建立连接的cache server列表，根据cache server会定时循环向master发送心跳包的特点，内部维护一个unordered_map结构，接收到cache心跳包时，便计数+1。因此可以比较在经过一段时候后，cache server列表的心跳包计数是否都有所增加，以此判断cache的存活状态，若计数不再增加可判断其已关闭，从cache server列表中删除此服务器，并通知其它服务器更新数据。</p>
<h3 id="master容灾"><a href="#master容灾" class="headerlink" title="master容灾"></a>master容灾</h3><p>设计主master和从master，主master定时循环向从master发送心跳包，从master通过对心跳包计数以判断主master存活情况，当其故障时，从master接替工作，并通知cache server列表中的所有服务器。</p>
<h2 id="核心代码分析"><a href="#核心代码分析" class="headerlink" title="核心代码分析"></a>核心代码分析</h2><h3 id="cache心跳包检测-1"><a href="#cache心跳包检测-1" class="headerlink" title="cache心跳包检测"></a>cache心跳包检测</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span>* <span class="title">heartstate</span><span class="params">(<span class="type">void</span>*)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(cachestatemap.<span class="built_in">size</span>()&gt;<span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            precachestatemap=cachestatemap;</span><br><span class="line">            <span class="built_in">delayms</span>(<span class="number">1500</span>);</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">auto</span> it=cachestatemap.<span class="built_in">begin</span>();it!=cachestatemap.<span class="built_in">end</span>();it++)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">auto</span> itt=precachestatemap.<span class="built_in">find</span>(it-&gt;first);</span><br><span class="line">                <span class="keyword">if</span>(itt!=precachestatemap.<span class="built_in">end</span>())</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">if</span>(it-&gt;second&lt;=itt-&gt;second)</span><br><span class="line">                    &#123;</span><br><span class="line">                        psshutport=it-&gt;first;</span><br><span class="line">                        psshutip=heartip;</span><br><span class="line">                        <span class="keyword">if</span>(passive_shutdown_flag==<span class="number">0</span>)</span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="keyword">if</span>(psshutport!=shutport)</span><br><span class="line">                                passive_shutdown_flag=<span class="number">1</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">if</span>(it-&gt;second&gt;<span class="number">1000</span>)</span><br><span class="line">                        it-&gt;second=<span class="number">0</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>建立cachestatemap维护cache心跳包的计算，循环检测，延时1.5后，所有cache的心跳包计数是否有所增加，若未增加时，判断其已被动关闭,此时将passive_shutdown_flag标志置1，并将被动关闭的cache服务器的IP和port保存至psshutport和psshutip中，供后续逻辑处理流程使用。</p>
<h3 id="master容灾-1"><a href="#master容灾-1" class="headerlink" title="master容灾"></a>master容灾</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span>* <span class="title">masterupdata</span><span class="params">(<span class="type">void</span>*)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    json heartbeat_json;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> serv_addr;</span><br><span class="line">    <span class="built_in">signal</span>(SIGPIPE,SIG_IGN);</span><br><span class="line">    <span class="built_in">bzero</span>(&amp;serv_addr,<span class="built_in">sizeof</span>(serv_addr));</span><br><span class="line">    <span class="type">socklen_t</span> serv_addr_len;</span><br><span class="line">    serv_addr.sin_family=AF_INET;</span><br><span class="line">    <span class="built_in">inet_pton</span>(AF_INET,SPAREMASTER_IP,&amp;serv_addr.sin_addr.s_addr);</span><br><span class="line">    serv_addr.sin_port=<span class="built_in">htons</span>(SPAREMASTER_PORT);</span><br><span class="line">    <span class="type">int</span> cfd=<span class="built_in">Socket_connect</span>(<span class="literal">true</span>,(<span class="keyword">struct</span> sockaddr*)&amp;serv_addr,<span class="built_in">sizeof</span>(serv_addr));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">int</span> n;</span><br><span class="line">        heartbeat_json=<span class="built_in">updatamaster</span>();</span><br><span class="line">        string buf=heartbeat_json.<span class="built_in">dump</span>();</span><br><span class="line">        buf+=<span class="string">&quot;\0&quot;</span>;</span><br><span class="line">        n=<span class="built_in">Write</span>(cfd,(<span class="type">char</span>*)buf.<span class="built_in">data</span>(),buf.<span class="built_in">length</span>());</span><br><span class="line">        <span class="keyword">if</span>(n&lt;<span class="number">0</span>)</span><br><span class="line">            cfd=<span class="built_in">Socket_connect</span>(<span class="literal">false</span>,(<span class="keyword">struct</span> sockaddr*)&amp;serv_addr,<span class="built_in">sizeof</span>(serv_addr));</span><br><span class="line">        <span class="built_in">delayms</span>(<span class="number">100</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> *<span class="title">masterstate</span><span class="params">(<span class="type">void</span>*)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">while</span>(master_recovery==<span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(masterstatemap.<span class="built_in">size</span>()&gt;<span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            premasterstatemap=masterstatemap;</span><br><span class="line">            <span class="built_in">delayms</span>(<span class="number">1500</span>);</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">auto</span> iter = masterstatemap.<span class="built_in">begin</span>(); iter != masterstatemap.<span class="built_in">end</span>(); iter++)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">auto</span> iterr = premasterstatemap.<span class="built_in">find</span>(iter-&gt;first);</span><br><span class="line">                <span class="keyword">if</span>(iterr!=premasterstatemap.<span class="built_in">end</span>())</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">if</span>(iter-&gt;second &lt;= iterr-&gt;second)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;IPportlist.<span class="built_in">size</span>();i++)</span><br><span class="line">                        &#123;</span><br><span class="line">                            string IPnow=IPportlist[i].<span class="built_in">substr</span>(<span class="number">0</span>,<span class="number">9</span>);</span><br><span class="line">                            string Portnow=IPportlist[i].<span class="built_in">substr</span>(<span class="number">10</span>,<span class="number">4</span>);</span><br><span class="line">                            <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> serv_addr;</span><br><span class="line">                            <span class="type">socklen_t</span> serv_addr_len;</span><br><span class="line">                            <span class="built_in">signal</span>(SIGPIPE, SIG_IGN);</span><br><span class="line">                            <span class="built_in">bzero</span>(&amp;serv_addr,<span class="built_in">sizeof</span>(serv_addr));</span><br><span class="line">                            serv_addr.sin_family = AF_INET;</span><br><span class="line">                            <span class="built_in">inet_pton</span>(AF_INET, IPnow.<span class="built_in">c_str</span>(), &amp;serv_addr.sin_addr.s_addr);</span><br><span class="line">                            serv_addr.sin_port = <span class="built_in">htons</span>(<span class="built_in">atoi</span>(Portnow.<span class="built_in">c_str</span>()));</span><br><span class="line">                            <span class="type">int</span> cfd = <span class="built_in">Socket_connect</span>(<span class="literal">true</span>, (<span class="keyword">struct</span> sockaddr *)&amp;serv_addr, <span class="built_in">sizeof</span>(serv_addr));</span><br><span class="line">                            <span class="type">int</span> flags=<span class="built_in">fcntl</span>(cfd,F_GETFL,<span class="number">0</span>);</span><br><span class="line">                            <span class="built_in">fcntl</span>(cfd,F_SETFL,flags|O_NONBLOCK);</span><br><span class="line">                            string buf1 = <span class="built_in">refreshmaster</span>().<span class="built_in">dump</span>();</span><br><span class="line">                            buf1+=<span class="string">&quot;\0&quot;</span>;</span><br><span class="line">                            <span class="type">int</span> n=<span class="number">0</span>;</span><br><span class="line">                            n = <span class="built_in">Write</span>(cfd, (<span class="type">char</span> *)buf1.<span class="built_in">data</span>(), buf1.<span class="built_in">length</span>()+<span class="number">1</span>);</span><br><span class="line">                            <span class="keyword">while</span>(n&lt;<span class="number">0</span>)</span><br><span class="line">                            &#123;</span><br><span class="line">                                cfd = <span class="built_in">Socket_connect</span>(<span class="literal">false</span>, (<span class="keyword">struct</span> sockaddr *)&amp;serv_addr, <span class="built_in">sizeof</span>(serv_addr));</span><br><span class="line">                                n = <span class="built_in">Write</span>(cfd, (<span class="type">char</span> *)buf1.<span class="built_in">data</span>(), buf1.<span class="built_in">length</span>()+<span class="number">1</span>);</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="built_in">Close</span>(cfd);</span><br><span class="line">                        &#125;</span><br><span class="line">                        IPportlist.<span class="built_in">clear</span>();</span><br><span class="line">                        master_recovery=<span class="number">1</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>主master模块创建新线程运行masterupdata函数，定时循环向从master发送心跳包。从master模块创建新线程运行masterstate函数，通过维护masterstatemap结构对主master心跳包计数，延时1.5s，判断心跳包计数是否有所增加，当未增加，判断此时主master已故障，因此遍历cache server列表，向内所有服务器发送类型为REFLESH_MASTER的json数据包，通知更新master的IP地址和端口号。</p>
<h3 id="master逻辑处理"><a href="#master逻辑处理" class="headerlink" title="master逻辑处理"></a>master逻辑处理</h3><h4 id="IO多路复用"><a href="#IO多路复用" class="headerlink" title="IO多路复用"></a>IO多路复用</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> openmax=<span class="number">1000</span>;</span><br><span class="line"><span class="type">int</span> num=<span class="number">0</span>;</span><br><span class="line"><span class="type">char</span> buf[BUFSIZ],str[openmax];</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> saddr,caddr;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">epoll_event</span> tep,ep[openmax];</span><br><span class="line"><span class="type">int</span> listen_num=<span class="number">10</span>;</span><br><span class="line"><span class="type">int</span> server_fd=<span class="built_in">Socket</span>(AF_INET,SOCK_STREAM,<span class="number">0</span>);</span><br><span class="line"><span class="type">int</span> opt=<span class="number">1</span>;</span><br><span class="line"><span class="built_in">setsockopt</span>(server_fd,SOL_SOCKET,SO_REUSEADDR,&amp;opt,<span class="built_in">sizeof</span>(opt));</span><br><span class="line"><span class="built_in">bzero</span>(&amp;saddr,<span class="built_in">sizeof</span>(saddr));</span><br><span class="line">saddr.sin_family=AF_INET;</span><br><span class="line">saddr.sin_port=<span class="built_in">htons</span>(MASTER_PORT);</span><br><span class="line">saddr.sin_addr.s_addr=<span class="built_in">inet_addr</span>(MASTER_IP);</span><br><span class="line"><span class="type">int</span> ret=<span class="built_in">Bind</span>(server_fd,(<span class="keyword">struct</span> sockaddr*)&amp;saddr,<span class="built_in">sizeof</span>(saddr));</span><br><span class="line">ret=<span class="built_in">Listen</span>(server_fd,listen_num);</span><br><span class="line"><span class="type">int</span> efd=<span class="built_in">Epoll_create</span>(openmax);</span><br><span class="line">tep.events=EPOLLIN|EPOLLET;</span><br><span class="line">tep.data.fd=server_fd;</span><br><span class="line"><span class="type">int</span> res=<span class="built_in">Epoll_ctl</span>(efd,EPOLL_CTL_ADD,server_fd,&amp;tep);</span><br><span class="line">cout&lt;&lt;<span class="string">&quot;等待客户端连接...&quot;</span>&lt;&lt;endl;</span><br></pre></td></tr></table></figure>
<p>通过socket、bind、listen函数创建socket套接字，并将其加入epoll函数，监听事件发生。</p>
<h4 id="新连接接入"><a href="#新连接接入" class="headerlink" title="新连接接入"></a>新连接接入</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(ep[i].data.fd==server_fd)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">socklen_t</span> clilen=<span class="built_in">sizeof</span>(caddr);</span><br><span class="line">    <span class="type">int</span> client_fd=<span class="built_in">Accept</span>(server_fd,(<span class="keyword">struct</span> sockaddr*)&amp;caddr,&amp;clilen);</span><br><span class="line">    <span class="keyword">auto</span> flag=<span class="built_in">fcntl</span>(client_fd,F_GETFL);</span><br><span class="line">    <span class="built_in">fcntl</span>(client_fd,F_SETFL,flag|O_NONBLOCK);</span><br><span class="line">    tep.events=EPOLLIN|EPOLLOUT|EPOLLET;</span><br><span class="line">    tep.data.fd=client_fd;</span><br><span class="line">    res=<span class="built_in">Epoll_ctl</span>(efd,EPOLL_CTL_ADD,client_fd,&amp;tep);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当监听事件文件描述符有IO响应时，代表有新连接（cache server或者client）接入，此时调用accept函数接收对端连接，并将其加入epoll函数中监听。</p>
<h4 id="逻辑处理"><a href="#逻辑处理" class="headerlink" title="逻辑处理"></a>逻辑处理</h4><ul>
<li>类型为DISTRIBUTION_REQUEST时，代表是client发来的拉取cache分布请求，master则调用Distributionresquest函数，其内部向client发送类型为DISTRIBUTION_RESPOND的json数据包，包含了master维护的cache server列表。<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(info[<span class="string">&quot;type&quot;</span>]==DISTRIBUTION_REQUEST)</span><br><span class="line">    <span class="built_in">Distributionresquest</span>(sockfd);</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Distributionresquest</span><span class="params">(<span class="type">int</span> clie_fd)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">pthread_rwlock_rdlock</span>(&amp;rw_lock);</span><br><span class="line">    json data,listip;</span><br><span class="line">    vector&lt;string&gt; dataip;</span><br><span class="line">    <span class="type">int</span> size=IPportlist.<span class="built_in">size</span>();</span><br><span class="line">    listip[<span class="string">&quot;type&quot;</span>]=DISTRIBUTION_RESPOND;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;size;i++)</span><br><span class="line">    &#123;</span><br><span class="line">        dataip.<span class="built_in">push_back</span>(IPportlist[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    data[<span class="string">&quot;iplist&quot;</span>]=dataip;</span><br><span class="line">    listip[<span class="string">&quot;data&quot;</span>]=data;</span><br><span class="line">    string str_out=listip.<span class="built_in">dump</span>();</span><br><span class="line">    str_out+=<span class="string">&quot;\0&quot;</span>;</span><br><span class="line">    <span class="built_in">Write</span>(clie_fd,(<span class="type">char</span>*)str_out.<span class="built_in">data</span>(),str_out.<span class="built_in">length</span>()+<span class="number">1</span>);</span><br><span class="line">    <span class="built_in">pthread_rwlock_unlock</span>(&amp;rw_lock);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>类型为SHUTDOWN_CACHE时，代表是接收到的主动关闭cache服务器指令，此时将json数据包内需要关闭的cache列表保存到shutipnow和shutportnow结构中，并将相关标志位置1。<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span>(info[<span class="string">&quot;type&quot;</span>]==SHUTDOWN_CACHE)</span><br><span class="line">&#123;</span><br><span class="line">    vector&lt;string&gt; userdata=info[<span class="string">&quot;data&quot;</span>][<span class="string">&quot;iplist&quot;</span>];</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;userdata.<span class="built_in">size</span>();i++)</span><br><span class="line">    &#123;</span><br><span class="line">        ipport_pair temp=<span class="built_in">get_ipport</span>(userdata[i]);</span><br><span class="line">        shutipnow.<span class="built_in">push_back</span>(temp.ip);</span><br><span class="line">        shutportnow.<span class="built_in">push_back</span>(<span class="built_in">to_string</span>(temp.port));</span><br><span class="line">    &#125;</span><br><span class="line">    shut_cache_size=shutportnow.<span class="built_in">size</span>();</span><br><span class="line">    cache_shutdown=<span class="number">1</span>;</span><br><span class="line">    cache_shutdown_type=<span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>类型为HEART_BEAT时，代表接收到了cache的心跳包，此时将心跳包的地址、状态保存下来，将心跳包计数+1，如果状态为false，则表示该cache主动关闭，将cache_shutdown_type标志置2。<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span>(info[<span class="string">&quot;type&quot;</span>]==HEART_BEAT)</span><br><span class="line">&#123;</span><br><span class="line">    string heartdata=info[<span class="string">&quot;data&quot;</span>][<span class="string">&quot;iplist&quot;</span>];</span><br><span class="line">    <span class="type">bool</span> heartstate=info[<span class="string">&quot;data&quot;</span>][<span class="string">&quot;state&quot;</span>];</span><br><span class="line">    ipport_pair temp=<span class="built_in">get_ipport</span>(heartdata);</span><br><span class="line">    heartip=temp.ip;</span><br><span class="line">    heartport=<span class="built_in">to_string</span>(temp.port);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">auto</span> it=cachestatemap.<span class="built_in">find</span>(heartport);</span><br><span class="line">    <span class="keyword">if</span>(it!=cachestatemap.<span class="built_in">end</span>())</span><br><span class="line">        (it-&gt;second++);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(heartstate==<span class="literal">false</span>)</span><br><span class="line">        cache_shutdown_type=<span class="number">2</span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>通过cache_shutdown_type标志判断是否需要关闭发送此心跳包的cache服务器，当标志为1时，表示处于主动关闭状态，判断cache地址是否出现在主动关闭cache列表中，如果出现，则将其保存在shutport和shutip中；当标志为2时，表示处于被动关闭状态，此时直接将cache地址保存在shutport和shutip中。<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(cache_shutdown_type==<span class="number">1</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">auto</span> it1=<span class="built_in">find</span>(shutportnow.<span class="built_in">begin</span>(),shutportnow.<span class="built_in">end</span>(),heartport);</span><br><span class="line">    <span class="keyword">if</span>(it1!=shutportnow.<span class="built_in">end</span>())</span><br><span class="line">        shutport=*it1;</span><br><span class="line">    <span class="keyword">auto</span> it2=<span class="built_in">find</span>(shutipnow.<span class="built_in">begin</span>(),shutipnow.<span class="built_in">end</span>(),heartip);</span><br><span class="line">    <span class="keyword">if</span>(it2!=shutipnow.<span class="built_in">end</span>())</span><br><span class="line">        shutip=*it2;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span>(cache_shutdown_type==<span class="number">2</span>)</span><br><span class="line">&#123;</span><br><span class="line">    shutport=heartport;</span><br><span class="line">    shutip=heartip;</span><br><span class="line">    cache_shutdown=<span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>在portlist中寻找，判断心跳包的cache是否出现过，如果未出现过，还要判断是否出现在主动关闭cache列表中，防止待关闭的cache发生重连现象。当它出现在主动关闭cache列表中时，将cache_shutdown_type标志置1，后续对标志进行判断，如果为0时，将cache地址加入到维护的各类列表中；标志为1时，重置标志后不做其它处理。<br><a target="_blank" rel="noopener" href="https://imgtu.com/i/XK2ZLj"><img src="https://s1.ax1x.com/2022/05/28/XK2ZLj.png" alt="cache扩容"></a><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">auto</span> result=<span class="built_in">find</span>(Portlist.<span class="built_in">begin</span>(),Portlist.<span class="built_in">end</span>(),<span class="built_in">atoi</span>(heartport.<span class="built_in">c_str</span>()));</span><br><span class="line"><span class="keyword">if</span>(result==Portlist.<span class="built_in">end</span>())</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span>(reconnect_count&lt;reconnect_maxnum)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">auto</span> itt=<span class="built_in">find</span>(shutportnow.<span class="built_in">begin</span>(),shutportnow.<span class="built_in">end</span>(),heartport);</span><br><span class="line">        <span class="keyword">if</span>(itt!=shutportnow.<span class="built_in">end</span>())</span><br><span class="line">            cache_shutdown_done=<span class="number">1</span>;</span><br><span class="line">        reconnect_count++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        cache_shutdown_done=<span class="number">0</span>;</span><br><span class="line">        reconnect_count=<span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">switch</span>(cache_shutdown_done)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">            IPlist.<span class="built_in">push_back</span>(heartip);</span><br><span class="line">            Portlist.<span class="built_in">push_back</span>(<span class="built_in">atoi</span>(heartport.<span class="built_in">c_str</span>()));</span><br><span class="line">            IPportlist.<span class="built_in">push_back</span>(heartdata);</span><br><span class="line">            cachemap.<span class="built_in">emplace</span>(heartport,<span class="number">0</span>);</span><br><span class="line">            cachemapshut.<span class="built_in">emplace</span>(heartport,<span class="number">0</span>);</span><br><span class="line">            cachestatemap.<span class="built_in">emplace</span>(heartport,<span class="number">0</span>);</span><br><span class="line">            masterupdatemap.<span class="built_in">emplace</span>(heartport,<span class="number">0</span>);</span><br><span class="line">            expan_flag=<span class="number">1</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">            cache_shutdown_done=<span class="number">0</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>当expan_flag标志为1时，表示有新cache加入，需要向其发送更新节点信息，查找cache地址是否出现在cachemap中，当出现并且计数为0时，向其发送更新节点信息，并将计数置1，然后增加cache_flesh_count计数，但计数等于cachemap大小时，表示已向所有节点发送更新信息，然后将expan_flag标志置0，cache_flesh_count计数归0，然后重置cachemap中所有cache计数。<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(expan_flag==<span class="number">1</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">vector</span>&lt;string&gt;().<span class="built_in">swap</span>(shutportnow);</span><br><span class="line">    <span class="built_in">vector</span>&lt;string&gt;().<span class="built_in">swap</span>(shutipnow);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">auto</span> it=cachemap.<span class="built_in">find</span>(heartport);</span><br><span class="line">    <span class="keyword">if</span>(it!=cachemap.<span class="built_in">end</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(it-&gt;second==<span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            it-&gt;second=<span class="number">1</span>;</span><br><span class="line">            cache_flesh_count++;</span><br><span class="line">            <span class="built_in">refreship</span>(sockfd);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(cache_flesh_count==cachemap.<span class="built_in">size</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        expan_flag=<span class="number">0</span>;</span><br><span class="line">        cache_flesh_count=<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">auto</span>&amp; v:cachemap)</span><br><span class="line">            v.second=<span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>当cache地址等于待关闭cache地址且cache_shutdown_type标志为1时，代表此时cache在主动关闭cache列表中，此时将其地址从各类列表中删除，然后调用refreship函数向其关闭节点命令，并且计数。当计数等于主动关闭cache列表大小时，代表所有主动关闭cache均已关闭，此时将相关标志位重置。<br><a target="_blank" rel="noopener" href="https://imgtu.com/i/XKR3Nt"><img src="https://s1.ax1x.com/2022/05/28/XKR3Nt.png" alt="cache主动缩容"></a><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(shutport==heartport&amp;&amp;cache_shutdown==<span class="number">1</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">auto</span> it=IPlist.<span class="built_in">begin</span>();it!=IPlist.<span class="built_in">end</span>();it++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(*it==shutip) </span><br><span class="line">        &#123;</span><br><span class="line">            IPlist.<span class="built_in">erase</span>(it);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">auto</span> it=Portlist.<span class="built_in">begin</span>();it!=Portlist.<span class="built_in">end</span>();it++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(*it==<span class="built_in">atoi</span>(shutport.<span class="built_in">c_str</span>()))</span><br><span class="line">        &#123;</span><br><span class="line">            Portlist.<span class="built_in">erase</span>(it);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">auto</span> it=IPportlist.<span class="built_in">begin</span>();it!=IPportlist.<span class="built_in">end</span>();it++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(*it==heartdata)</span><br><span class="line">        &#123;</span><br><span class="line">            IPportlist.<span class="built_in">erase</span>(it);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">auto</span> it1=cachemap.<span class="built_in">find</span>(heartport);</span><br><span class="line">    <span class="keyword">if</span>(it1!=cachemap.<span class="built_in">end</span>())</span><br><span class="line">        cachemap.<span class="built_in">erase</span>(it1);</span><br><span class="line">    <span class="keyword">auto</span> it2=cachemapshut.<span class="built_in">find</span>(heartport);</span><br><span class="line">    <span class="keyword">if</span>(it2!=cachemapshut.<span class="built_in">end</span>())</span><br><span class="line">        cachemapshut.<span class="built_in">erase</span>(it2);</span><br><span class="line">    <span class="keyword">auto</span> it3=cachestatemap.<span class="built_in">find</span>(heartport);</span><br><span class="line">    <span class="keyword">if</span>(it3!=cachestatemap.<span class="built_in">end</span>())</span><br><span class="line">        cachestatemap.<span class="built_in">erase</span>(it3);</span><br><span class="line">    <span class="keyword">auto</span> it4=precachestatemap.<span class="built_in">find</span>(heartport);</span><br><span class="line">    <span class="keyword">if</span>(it4!=precachestatemap.<span class="built_in">end</span>())</span><br><span class="line">        precachestatemap.<span class="built_in">erase</span>(it4);</span><br><span class="line">    <span class="keyword">auto</span> it5=masterupdatemap.<span class="built_in">find</span>(heartport);</span><br><span class="line">    <span class="keyword">if</span>(it5!=masterupdatemap.<span class="built_in">end</span>())</span><br><span class="line">        masterupdatemap.<span class="built_in">erase</span>(it5);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">refreship</span>(sockfd);</span><br><span class="line">    cache_shutdown_count++;</span><br><span class="line">    flag8=<span class="number">1</span>;</span><br><span class="line">    reconnect_maxnum=<span class="number">20</span>;</span><br><span class="line">    shutport=<span class="string">&quot;&quot;</span>;</span><br><span class="line">    shutip=<span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">if</span>((cache_shutdown_type==<span class="number">1</span>||cache_shutdown_type==<span class="number">2</span>)&amp;&amp;(cache_shutdown_count==shut_cache_size&amp;&amp;flag8==<span class="number">1</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        cache_shutdown_count=<span class="number">0</span>;</span><br><span class="line">        cache_shutdown=<span class="number">0</span>;</span><br><span class="line">        allcache_shutdown_down=<span class="number">1</span>;</span><br><span class="line">        cache_shutdown_done=<span class="number">1</span>;</span><br><span class="line">        cache_shutdown_type=<span class="number">0</span>;</span><br><span class="line">        flag8=<span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>当passive_shutdown_flag标志为1时，表示此时cache进入被动关闭状态，将其地址从各类列表中删除。<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span>(passive_shutdown_flag==<span class="number">1</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">auto</span> it=IPlist.<span class="built_in">begin</span>();it!=IPlist.<span class="built_in">end</span>();it++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(*it==psshutip)</span><br><span class="line">        &#123;</span><br><span class="line">            IPlist.<span class="built_in">erase</span>(it);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">auto</span> it=Portlist.<span class="built_in">begin</span>();it!=Portlist.<span class="built_in">end</span>();it++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(*it==<span class="built_in">atoi</span>(psshutport.<span class="built_in">c_str</span>()))</span><br><span class="line">        &#123;</span><br><span class="line">            Portlist.<span class="built_in">erase</span>(it);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    string temp=psshutip+<span class="string">&quot;:&quot;</span>+psshutport;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">auto</span> it=IPportlist.<span class="built_in">begin</span>();it!=IPportlist.<span class="built_in">end</span>();it++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(*it==temp)</span><br><span class="line">        &#123;</span><br><span class="line">            IPportlist.<span class="built_in">erase</span>(it);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">auto</span> it1=cachemap.<span class="built_in">find</span>(psshutport);</span><br><span class="line">    <span class="keyword">if</span>(it1!=cachemap.<span class="built_in">end</span>())</span><br><span class="line">        cachemap.<span class="built_in">erase</span>(it1);</span><br><span class="line">    <span class="keyword">auto</span> it2=cachemapshut.<span class="built_in">find</span>(psshutport);</span><br><span class="line">    <span class="keyword">if</span>(it2!=cachemapshut.<span class="built_in">end</span>())</span><br><span class="line">        cachemapshut.<span class="built_in">erase</span>(it2);</span><br><span class="line">    <span class="keyword">auto</span> it3=cachestatemap.<span class="built_in">find</span>(psshutport);</span><br><span class="line">    <span class="keyword">if</span>(it3!=cachestatemap.<span class="built_in">end</span>())</span><br><span class="line">        cachestatemap.<span class="built_in">erase</span>(it3);</span><br><span class="line">    <span class="keyword">auto</span> it4=precachestatemap.<span class="built_in">find</span>(psshutport);</span><br><span class="line">    <span class="keyword">if</span>(it4!=precachestatemap.<span class="built_in">end</span>())</span><br><span class="line">        precachestatemap.<span class="built_in">erase</span>(it4);</span><br><span class="line">    <span class="keyword">auto</span> it5=masterupdatemap.<span class="built_in">find</span>(psshutport);</span><br><span class="line">    <span class="keyword">if</span>(it5!=masterupdatemap.<span class="built_in">end</span>())</span><br><span class="line">        masterupdatemap.<span class="built_in">erase</span>(it5);</span><br><span class="line"></span><br><span class="line">    allcache_shutdown_down=<span class="number">1</span>;</span><br><span class="line">    cache_shutdown_done=<span class="number">1</span>;</span><br><span class="line">    reconnect_maxnum=<span class="number">20</span>;</span><br><span class="line">    flag8=<span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>当allcache_shutdown_done标志为1时，表示所有需要关闭的cache服务均已关闭，此时需要向其它cache服务器发送刷新节点命令，通过cachemapshut结构保存是否发送标志，未发送置将标志置1，计数增加后调用refleship函数向其发送刷新列表指令，当计数等于cachemapshut结构大小时，表示发送完毕，此时重置相关标志位。<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(allcache_shutdown_down==<span class="number">1</span>&amp;&amp;flag8==<span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">auto</span> it=cachemapshut.<span class="built_in">find</span>(heartport);</span><br><span class="line">    <span class="keyword">if</span>(it!=cachemapshut.<span class="built_in">end</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(it-&gt;second==<span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            it-&gt;second=<span class="number">1</span>;</span><br><span class="line">            num2++;</span><br><span class="line">            <span class="built_in">refreship</span>(sockfd);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(num2==cachemapshut.<span class="built_in">size</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        allcache_shutdown_down=<span class="number">0</span>;</span><br><span class="line">        passive_shutdown_flag=<span class="number">0</span>;</span><br><span class="line">        num2=<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">auto</span>&amp; v:cachemapshut)</span><br><span class="line">            v.second=<span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/%E5%AD%A6%E4%B9%A0%E6%97%A5%E5%BF%97/" rel="tag"># 学习日志</a>
              <a href="/tags/master/" rel="tag"># master</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2022/05/20/%E9%A6%96%E9%A1%B5/" rel="prev" title="学习博客">
      <i class="fa fa-chevron-left"></i> 学习博客
    </a></div>
      <div class="post-nav-item"></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%95%B4%E4%BD%93%E6%A6%82%E8%BF%B0"><span class="nav-number">1.</span> <span class="nav-text">整体概述</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86"><span class="nav-number">2.</span> <span class="nav-text">基础知识</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#master%E6%95%B0%E6%8D%AE%E6%94%B6%E5%8F%91"><span class="nav-number">2.1.</span> <span class="nav-text">master数据收发</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#cache%E5%BF%83%E8%B7%B3%E5%8C%85%E6%A3%80%E6%B5%8B"><span class="nav-number">2.2.</span> <span class="nav-text">cache心跳包检测</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#master%E5%AE%B9%E7%81%BE"><span class="nav-number">2.3.</span> <span class="nav-text">master容灾</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A0%B8%E5%BF%83%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90"><span class="nav-number">3.</span> <span class="nav-text">核心代码分析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#cache%E5%BF%83%E8%B7%B3%E5%8C%85%E6%A3%80%E6%B5%8B-1"><span class="nav-number">3.1.</span> <span class="nav-text">cache心跳包检测</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#master%E5%AE%B9%E7%81%BE-1"><span class="nav-number">3.2.</span> <span class="nav-text">master容灾</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#master%E9%80%BB%E8%BE%91%E5%A4%84%E7%90%86"><span class="nav-number">3.3.</span> <span class="nav-text">master逻辑处理</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#IO%E5%A4%9A%E8%B7%AF%E5%A4%8D%E7%94%A8"><span class="nav-number">3.3.1.</span> <span class="nav-text">IO多路复用</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%96%B0%E8%BF%9E%E6%8E%A5%E6%8E%A5%E5%85%A5"><span class="nav-number">3.3.2.</span> <span class="nav-text">新连接接入</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%80%BB%E8%BE%91%E5%A4%84%E7%90%86"><span class="nav-number">3.3.3.</span> <span class="nav-text">逻辑处理</span></a></li></ol></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="gong luyang"
      src="/images/%E5%A4%B4%E5%83%8F.png">
  <p class="site-author-name" itemprop="name">gong luyang</p>
  <div class="site-description" itemprop="description">learn</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">16</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">2</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">17</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/glyhust" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;glyhust" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:gly_hk@163.com" title="E-Mail → mailto:gly_hk@163.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">gong luyang</span>
</div>


<!--
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>-->

        








      </div>
    </footer>
  </div>

  <div class="bg_content">
  <canvas id="canvas"></canvas>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>

<script type="text/javascript" src="/js/dynamic_bg.js"></script>
